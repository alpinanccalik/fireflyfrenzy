<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Firefly Frenzy: Own Mode</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box }
  body { 
    overflow:hidden; 
    background:url('poser1.gif') center center / cover no-repeat; 
    background-size: cover;
    transition: background-image 1s ease-in-out;
    color:#fff; 
    font-family:sans-serif 
  }
  canvas { display:block }
  #stopBtn {
    position:absolute; top:10px; right:10px;
    padding:8px 12px; font-size:14px; cursor:pointer;
    background:#c00; border:none; border-radius:4px; color:#fff; z-index:100;
  }
  #overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.9);
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    text-align:center; padding:20px;
  }
  #overlay.hidden { visibility:hidden }
  #overlay h1 { font-size:36px; margin-bottom:20px }
  #overlay p { font-size:20px; margin-bottom:30px; max-width:600px }
  #overlay button {
    padding:10px 20px; font-size:18px; cursor:pointer;
    background:#0c0; border:none; border-radius:5px; color:#000;
    margin:5px;
  }
  #uploadSection {
    margin-top:20px;
  }
  #uploadInput {
    margin-top:10px;
  }
</style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <button id="stopBtn">Stop the Poser Audio</button>

  <div id="overlay">
    <h1>Firefly Frenzy: Own Mode</h1>
    <p id="overlayText">
      Upload your own samples! Recommended: anime_sample1.mp3, snare.mp3, kick.mp3, etc. <br/>
      Yellow = Snare, Green = Kick, Blue = Random Anime Sample, Orange = Amen Break (loops), Purple = Ambient Loop (loops). <br/>
      !! Please wear headphones for MAXIMUM breakcore !! 
    </p>

    <div id="uploadSection">
      <input type="file" id="uploadInput" multiple accept=".mp3" />
      <p style="margin-top:10px;">Upload at least 4 anime samples, 1 snare, 1 kick, and a loop for best experience.</p>
    </div>

    <button id="overlayBtn">Start Breaking</button>
  </div>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
  window.addEventListener('resize', resize);
  resize();

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const buffers = {
    snare: null,
    kick: null,
    cymbal: null,
    loop: [],
    anime: []
  };

  const activeSources = new Set();

  function playOne(buffer) {
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.connect(audioCtx.destination);
    activeSources.add(src);
    src.onended = () => activeSources.delete(src);
    src.start();
  }

  function playLoop(buffer, count) {
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.loop = true;
    src.connect(audioCtx.destination);
    activeSources.add(src);
    src.onended = () => activeSources.delete(src);
    src.start();
    setTimeout(() => src.stop(), buffer.duration * count * 1000);
  }

  const stopBtn = document.getElementById('stopBtn');
  stopBtn.addEventListener('click', () => {
    for (let src of activeSources) {
      try { src.stop(); } catch {}
    }
    activeSources.clear();
  });

  let fireflies = [], score = 0, level = 1, catches = 0;
  let spawnInterval = 2000, spawnTimer = 0, lastTime = 0;
  let running = false, gameOver = false;

  const overlay = document.getElementById('overlay');
  const overlayBtn = document.getElementById('overlayBtn');

  let mouse = { x: 0, y: 0, down: false };
  canvas.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
  canvas.addEventListener('mousedown', () => mouse.down = true);
  canvas.addEventListener('mouseup', () => mouse.down = false);

  // ---- Upload Handling ----
  const uploadInput = document.getElementById('uploadInput');
  uploadInput.addEventListener('change', (event) => {
    const files = event.target.files;
    for (let file of files) {
      const reader = new FileReader();
      reader.onload = function(e) {
        audioCtx.decodeAudioData(e.target.result).then(buffer => {
          if (file.name.includes('snare')) {
            buffers.snare = buffer;
          } else if (file.name.includes('kick')) {
            buffers.kick = buffer;
          } else if (file.name.includes('loop')) {
            buffers.loop.push(buffer);
          } else if (file.name.includes('cymbal') || file.name.includes('amen')) {
            buffers.cymbal = buffer;
          } else if (file.name.includes('anime')) {
            buffers.anime.push(buffer);
          } else {
            console.warn('Unknown file type:', file.name);
          }
        }).catch(err => console.error('Decode error', err));
      };
      reader.readAsArrayBuffer(file);
    }
  });

  class Firefly {
    constructor() {
      this.r = 5 + Math.random() * 5;
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.vx = (Math.random() - 0.5) * (1 + 0.2 * level);
      this.vy = (Math.random() - 0.5) * (1 + 0.2 * level);

      let types = ['snare', 'kick', 'hihat', 'cymbal'];
      if (!fireflies.some(f => f.type === 'loop')) types.push('loop');

      this.type = types[Math.floor(Math.random() * types.length)];
      switch (this.type) {
        case 'snare':
          this.colStart = 'rgba(255, 255, 180, 0.8)'; 
          this.colEnd = 'rgba(255, 255, 180, 0)';
          this.buf = buffers.snare; this.scoreVal = 1;
          break;
        case 'kick':
          this.colStart = 'rgba(180, 255, 180, 0.8)';
          this.colEnd = 'rgba(180, 255, 180, 0)';
          this.buf = buffers.kick; this.scoreVal = 1;
          break;
        case 'hihat':
          this.colStart = 'rgba(180, 220, 255, 0.8)';
          this.colEnd = 'rgba(180, 220, 255, 0)';
          if (buffers.anime.length > 0) {
            this.buf = buffers.anime[Math.floor(Math.random() * buffers.anime.length)];
          }
          this.scoreVal = 1;
          break;
        case 'cymbal':
          this.colStart = 'rgba(255, 210, 170, 0.8)';
          this.colEnd = 'rgba(255, 210, 170, 0)';
          this.buf = buffers.cymbal; this.scoreVal = 1;
          break;
        case 'loop':
          this.colStart = 'rgba(220, 180, 255, 0.8)';
          this.colEnd = 'rgba(220, 180, 255, 0)';
          if (buffers.loop.length > 0) {
            this.buf = buffers.loop[Math.floor(Math.random() * buffers.loop.length)];
          }
          this.scoreVal = 2;
          break;
      }
    }
    update(dt) {
      this.x += this.vx * dt / 16;
      this.y += this.vy * dt / 16;
      if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
      if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
    }
    draw() {
      ctx.beginPath();
      ctx.fillStyle = this.colStart;
      ctx.arc(this.x, this.y, this.r * 2, 0, 2 * Math.PI);
      ctx.fill();
    }
  }

  function spawnFirefly() {
    fireflies.push(new Firefly());
  }

  function resetGame() {
    fireflies = [];
    score = 0; level = 1; catches = 0;
    spawnInterval = 2000; spawnTimer = 0;
    gameOver = false;
  }

  overlayBtn.addEventListener('click', () => {
    if (!running || gameOver) {
      overlay.classList.add('hidden');
      resetGame();
      running = true; lastTime = performance.now();
      for (let i = 0; i < 5; i++) spawnFirefly();
      requestAnimationFrame(gameLoop);
    }
  });

  function showGameOver() {
    running = false; gameOver = true;
    overlay.querySelector('p').textContent = `Game Over! Final Score: ${score}`;
    overlayBtn.textContent = 'Remix Again';
    overlay.classList.remove('hidden');
  }

  const backgrounds = ['poser1.gif', 'poser2.gif', 'poser3.gif', 'poser4.gif'];
  let current = 0;
  setInterval(() => {
    current = (current + 1) % backgrounds.length;
    document.body.style.backgroundImage = `url('${backgrounds[current]}')`;
  }, 5000);

  function gameLoop(now) {
    if (!running) return;
    const dt = now - lastTime; lastTime = now;
    spawnTimer += dt;
    if (spawnTimer > spawnInterval) {
      spawnFirefly();
      spawnTimer -= spawnInterval;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = fireflies.length - 1; i >= 0; i--) {
      const f = fireflies[i];
      f.update(dt);
      if (mouse.down) {
        const dx = f.x - mouse.x, dy = f.y - mouse.y;
        if (Math.hypot(dx, dy) < f.r * 4) {
          if (f.type === 'cymbal' || f.type === 'loop') {
            playLoop(f.buf, 16);
          } else {
            playOne(f.buf);
          }
          fireflies.splice(i, 1);
          score += f.scoreVal;
          catches++;
          if (catches >= 10) {
            level++; catches = 0;
            spawnInterval = Math.max(500, spawnInterval * 0.9);
          }
          if (level > 10) showGameOver();
        }
      }
      f.draw();
    }
    if (mouse.down) {
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(255,255,255,0.7)';
      ctx.lineWidth = 2;
      ctx.arc(mouse.x, mouse.y, 30, 0, 2 * Math.PI);
      ctx.stroke();
    }
    requestAnimationFrame(gameLoop);
  }
</script>
</body>
</html>
